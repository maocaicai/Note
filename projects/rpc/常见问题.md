### Netty的线程模型是怎样的

netty线程模型基于reactor线程模型，可以自定义各eventLoopGroup中的最大线程数

**netty 的线程模型并不是一成不变的，它实际取决于用户的启动参数配置。通过设置不同的启动参数，Netty 可以同时支持 Reactor 单线程模型、多线程模型。**![img](https://pic4.zhimg.com/80/v2-74b52eea7f1e9ab748a759edb69a2857_1440w.webp)

![img](https://pic3.zhimg.com/80/v2-7d31e6c3f14461dc1716841503893c2a_1440w.webp)

为了提高效率，在 I/O 线程内部进行串行操作，避免多线程竞争导致的性能下降问题。同时进行多个串行化操作，pipeline通道中注册多个handler处理器，会通过责任链模式依次调用。

**Netty 的 NioEventLoop 读取到消息之后，直接调用 ChannelPipeline 的`fireChannelRead (Object msg)`。** 只要用户不主动切换线程， 一直都是由NioEventLoop 调用用户的 ChannelHandler，期间不进行线程切换。这种串行化处理方式避免了多线程操作导致的锁的竞争，从性能角度看是最优的。

Netty拥有两个NIO线程池，分别是**`bossGroup`和`workerGroup`**，**前者处理新建连接请求**，然后将新建立的连接轮询交给workerGroup中的其中一个NioEventLoop来处理，**后续该连接上的读写操作都是由同一个NioEventLoop来处理**。注意，虽然bossGroup也能指定多个NioEventLoop（一个NioEventLoop对应一个线程），但是默认情况下只会有一个线程，**因为一般情况下应用程序只会使用一个对外监听端口**。

**netty单线程模型**：

Reactor 单线程模型，是指所有的 I/O 操作都在同一个 NIO 线程上面完成的，此时NIO线程职责包括：接收新建连接请求、读写操作等。![img](https://pic3.zhimg.com/80/v2-a4402f241617ad409a0348342669706a_1440w.webp)

**Reactor多线程模型**：

Reactor 多线程模型与单线程模型最大的区别就是**有一组 NIO 线程来处理连接读写操作**，一个NIO线程处理Accept。一个NIO线程可以处理多个连接事件，一个连接的事件只能属于一个NIO线程。

![img](https://pic3.zhimg.com/80/v2-7856189bd9d0b877d0a80037967cacc6_1440w.webp)

**Reactor主从多线程模型**：

主从 Reactor 线程模型的特点是：**服务端用于接收客户端连接的不再是一个单独的 NIO 线程，而是一个独立的 NIO 线程池。**Acceptor 接收到客户端 TCP连接请求并处理完成后（可能包含接入认证等），将**新创建的 SocketChannel注 册 到 I/O 线 程 池**（sub reactor 线 程 池）的**某个I/O线程**上， 由它负责SocketChannel 的读写和编解码工作。**Acceptor 线程池仅仅用于客户端的登录、握手和安全认证**，一旦链路建立成功，就将链路注册到后端 subReactor 线程池的 I/O 线程上，由 I/O 线程负责后续的 I/O 操作。

![img](https://pic2.zhimg.com/80/v2-093e32f05ea5f2a600bd218bacc8b989_1440w.webp)





### 谈谈你对Netty的全部了解

首先介绍BIONIOAIO等等通信模式

然后介绍Netty的通信模式是NIO，使用的Reactor模型，模型也可以根据设置修改

是可配置的，bootstrap，内部可以使用自定义处理器，加入到pipeline中，通过串行去执行handler任务

主要用于各种通信框架中，并且开源性能高成熟稳定使用简单

内部有线程模型、内存池、内存零拷贝设计，优化性能，可配置参数，使用串行化的io减少锁竞争

自带链路有效监测、粘包拆包问题、优雅停机

可定制、易扩展。

**责任链模式** ：ChannelPipeline 基于责任链模式开发，便于业务逻辑的拦

截、定制和扩展。

**基于接口的开发** ：关键的类库都提供了接口或抽象类，便于用户自定义

实现。

**提供大量的工厂类** ：通过重载这些工厂类，可以按需创建出用户需要的

对象。

**提供大量系统参数** ：供用户按需设置，增强系统的场景定制性



### Netty里面的EventLoop是什么？工作原理是怎样的？可以执行哪些任务？

**EventLoop本质上就是一个[Selector](https://so.csdn.net/so/search?q=Selector&spm=1001.2101.3001.7020)+一个单线程执行器。里面的run方法处理channel上源源不断的io事件**

eventloop相当于一个线程，每个线程绑定了一个channel，netty中都是存在于**eventloopgroup**中（**默认线程数为cpu*2**），每次处理时拿出一条eventloop线程

可以处理**定时任务或者普通任务**。   

```java
 public static void main(String[] args) {
        // 创建EventLoopGroup，它是一个接口，常用的使用就是NioEventLoopGroup
        // 它可以处理io事件，普通任务，定时任务
        // 还有另一个实现 DefaultEventLoop 它可以处理普通任务，定时任务。适用于一些没有io事件发生的场景    
EventLoopGroup eventLoopGroup = new NioEventLoopGroup();
    // 获取下一个EventLoop对象
    eventLoopGroup.next();

    // 执行普通任务，因为它还有线程池的方法，就可以使用submit(Runnable run)方法来执行一个普通任务
    // 执行普通任务的好处是可以执行一个异步处理
    eventLoopGroup.next().execute(() -> {
        log.debug("执行普通任务");
    });

    // 执行定时任务 scheduleAtFixedRate（任务对象，初始延迟时间 ， 间隔时间 ， 时间单位）
    // 下面的含义是，刚开始等待1秒执行，然后接下来每隔两秒执行一次
    eventLoopGroup.next().scheduleAtFixedRate(() -> {
        log.debug("执行定时任务");
    } , 1 , 2 , TimeUnit.SECONDS);

}
```
**可以处理io事件**

重写管道初始化方法，在pipeline管道中添加处理器handler，责任链模式去串行执行任务：

```java
@Slf4j
public class EventLoopGroupServerTest2 {
    public static void main(String[] args) {
        new ServerBootstrap()
                .group(new NioEventLoopGroup())
                .channel(NioServerSocketChannel.class)
                .childHandler(new ChannelInitializer<NioSocketChannel>() {
                    @Override
                    protected void initChannel(NioSocketChannel socketChannel) throws Exception {
                        // 这里就没有定义处理ByteBuf和字符串转换的Handler，仅仅定义一个，现在自己进行转换
                        socketChannel.pipeline().addLast(new ChannelInboundHandlerAdapter(){
                            @Override
                           public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
                                ByteBuf byteBuf = (ByteBuf) msg;
                                log.debug("接收客户端的消息为：" + byteBuf.toString(Charsets.UTF_8));
                            }
                        });
                    }
                })
                .bind(8080);
    }
}

```

这里其实又有一个线程切换的知识点，因为一个EventLoop就相当于是一个线程，这里将pipeline其中的一个Handler给其他EventLoop去执行就有一个线程切换的问题，那么是这两个线程是如何切换的嘞？
关键代码io.netty.channel.AbstractChannelHandlerContext类的**invokeChannelRead()**方法



### EventLoop为什么实现了ScheduleExecutorService的功能，有什么好处？

**可以处理定时任务**

EventLoop它继承两个类

- 第一个是继承netty自己的OrderedEventExecutor接口
- 第二个是继承java.util.concurrent.ScheduledExecutorService接口

### 讲讲你项目里提到的RPC分布式框架

### 使用zookeeper作为注册中心，当server端服务下线了，如何让client端感知到？

用map作缓存，client调用时会判断map中是否存在服务，不存在去zk中查询，zk没有说明服务下线了，那么client也会作下线判断

### 分布式体系中zookeeper崩溃了有哪些解决方案？

### 

### IDL在你的RPC框架中有实现吗，讲讲IDL的作用

2.1 问我RPC中的线程模型，比如说主线程、工作线程，这些我是怎么设计的（一个线程池用于IO多路复用监听连接（netty自带），一个线程池用于处理连接的事件循环（netty自带）） .. 这里忘了说设置了一个特定的线程池处理请求的实际逻辑，妈的寄了

2.2 又扯到了线程池的参数设置（常规八股）

2.3 我看你单机多实例的TPS反而比单机单实例的还低，有思考过为什么吗？（我觉得是因为单机的性能有限制，单实例就已经打满了，再多实例就会多出额外的没必要的开销）

2.4 你说单实例被打满，那再按照你的设计细分一下被打满的场景（如何被打满？），在这些场景下的线程池又要分别如何设置（我听不懂题目，他提醒我，从请求的处理逻辑过于简单和过于复杂两方面进行考虑）

2.5 为什么采用RPC，而不是采用HTTP（常规八股，可能面试官在想其他问题 丢我一个八股）

2.6 我看你使用了nacos作为服务注册中心，那么使用nacos有什么好处呢？（我说我没了解太多，只是用来当注册中心的，所以换了个问题，哈哈 其实只是nacos因为能给定服务实例权重，方便我实现随机权重算法哈哈哈哈哈）

2.7 你使用的负载均衡算法（随机权重、一致性哈希），是在哪里负载均衡的（客户端还是服务端）？

2.8 随机权重算法的使用场景（我答了有权重）、一致性哈希的使用场景（答了高可用，防止请求打不到实例上；哎我这里的理解有错，应该是防止请求打到不同实例上）

2.9 那么有权重的场景都使用随机权重，其他场景都使用一致性哈希吗？随机权重就会出现请求打不到实例上的问题吗？（我觉得是不会的）

2.10 那么我给定你一个场景，各个实例的状态都是相同的（也就是说他们的负载能力、剩余内存大小都是相同的、打在不同实例上的结果也是相同的，他们之间没有任何区别），那么你还会接着使用一致性哈希算法吗？（这个问题其实我当时有点懵，实例的状态相同和我一致性哈希有什么关系，我是为了高可用性啊；最后他说不是什么场景都能用一致性哈希的... 我就顺带回答一句 确实 计算哈希的开销会比随机权重更大）

​    复盘之后发现，是我对于一致性哈希的使用场景理解不到位...所以导致我对面试官的问题都理解得不清晰

2.10 随机权重算法具体如何实现？

2.11 如果带权重的话，要如何实现一致性哈希？

（我这里真的答得烂透了...没有实际地区分它们各自的适用场景）



复盘时仔细总结了一下它们各自的使用场景

这里需要实际清楚**一致性哈希**的使用场景，是为了**保证信息相同的请求能够尽量地打到同一个实例上**（因为如果请求在实例中保存数据，那实例的不同就会造成取不到这些数据导致错误，这时候就需要数据迁移）（这里没有考虑服务实例之间的数据一致性，有可能它们会进行数据同步也不一定），在集群扩容缩容时，一致性哈希可以减少数据的迁移量，只有一部分的请求会打到不同的实例上。所以**一致性哈希适用于需要使用节点存储数据（打到不同实例上会出现不同结果）、并且节点个数会动态变化的场景**。

 而**随机权重算法**的使用场景，则适用于**不同的服务实例具有不同的负载能力、处理优先级**的场景，每个服务实例具有不同的权重（在默认权重下就退化成朴素的随机算法了），请求打在权重较高的实例上的概率会更高。但是随机权重算法没有考虑到数据的迁移问题，所以应该适用于 **不需要使用节点存储数据，打在哪个实例上都没有区别 得到的结果都是相同的，但是需要考虑各个实例具有不同负载能力的场景**。







粘包拆包是什么，怎么解决？

-- 服务器处于假死状态，但没有主动关闭，问怎么办？

-- netty心跳检测，让调用方去向提供方发送探测报文

-- 能不能统一的向服务端发送探测报文？

\>> 将检测程序部署在一个机器上，去注册中心获取提供方的ip地址和端口号，专门负责检测

-- 如果检测机器和目标机器之间的网络出现故障，怎么办

-- 让多台检测机器分别部署，网络同时故障的概率小

实际上就是09丨健康检测：这个节点都挂了，为啥还要疯狂发请求？.pdf







1、除了项目上写的序列化框架还了解其他序列化框架吗？

2、解释一下什么是粘包，什么是拆包

3、有没有了解过netty里自己解决粘包拆包的？

4、HTTP如何解决粘包问题的？（header字段？）

5、HTTP中的content-length和chunk（听着好像是这么读的）解决粘包知不知道？

6、这个RPC框架是基于看过别的框架的东西吗？

7、zookeeper作为注册中心是怎么存储的，存储了什么数据在zookeeper中？

8、服务端将服务注册进去，客户端请求服务，这个过程在项目中大概是什么样子的，描述一下？

9、为什么要把每个服务端注册成临时节点？

10、客户端发起调用的时候每次都去获取节点信息吗？

11、如果每次都获取的话性能就会比较低，有没有什么优化方案？（用watcher）

12、使用watcher的时候需要注意什么？watcher回调完后还要做什么事情吗？

13、有自己搭了zookeeper集群吗？

14、zookeeper集群里会有哪些角色？

15、为什么要设计observer呢？它既不参与leader竞选，也不参与数据过半写成功？

16、rpc中应用线程池调用者发送调用后，请求跟响应是怎么异步关联的呢？（回调）

17、基于回调要怎么异步关联起来呢，有没有什么思路？







### 学生论坛项目的问题

#### 2.12 我看你的另一个项目 学生论坛，里面有说到两个定时任务（1、定期批量地将点赞关注数据持久化到mysql中；2、定期刷新帖子的热度，并刷新热帖排行），那么为什么这两个任务要定期呢？批量又是怎么个批量法呢？（常规）

#### 2.13 你的帖子内容，具体是如何存放的呢？是直接用mysql存的吗？（提到了使用es，倒排索引，对比mysql的优势）

### 接下来就有点高潮了，直接在这个基础上加了场景题（可能因为我提到了es，借它之手来问我，实际上与es毫无关系）

### 场景题：

#### 1、那就说说es，在使用es的场景下，如果帖子存的太多了，那是不是会导致它的性能下降，这时候你会怎么办？（搭集群）

#### 2、在搭集群的场景下，如果你想要用es通过前缀查询，查询到热度为top10或者top100的帖子，这里不考虑es实际的底层原理（因为他也不懂），就让你想一想要怎么实现？（这里我以为是问是集群是怎么运作的，答了主从架构，在从节点中各自取top100，再交给主节点进行排序，再取出最终的top100）

#### 3、在单机的场景下，你es节点要通过前缀查询，查询到热度top100的帖子，这种算法你会如何设计？会考虑使用什么数据结构？这里要求响应要很快（原本我还以为要考虑字符串匹配的算法、然后再考虑排序的算法；没答上来，他提醒了trie树，但我觉得这种做法会OOM，然后他叫我不考虑内存，在集群架构下可以分摊给别的节点，哎我果然是刷题思维，跟他们这种工作多年相比本质上真的有区别）

#### 4、接着上面那一题，如果使用trie树，在一个帖子被点赞、访问时（也就是它的热度更新时），你会如何维护这个trie树？时间复杂度为多少？



### 3、计网

#### 3.1 给定你一个场景，发送端和接收端建立了TCP连接，正在传输数据，如果此时接收端进程宕机了（是进程宕机哦），而发送端并不知道，这时候会发生什么样的事情？（一开始回答了保活机制，但被面试官提醒了；然后又回答没有ack 导致发送端阻塞 超时重传；经过提醒才知道原来tcp是由操作系统的协议栈控制的，只要主机没宕掉就仍然会ack...接下来你们自己想咯？）（不过我在看小林coding的时候说 进程崩溃时，内核会自动回收它的资源，所以socket也会被回收，并且发送四次挥手断开连接.. 不知道是面试官错了还是小林错了）

### 场景题又来喽

### 场景题

#### 1、如果你要基于TCP协议，传输一个大文件，传输的过程中很有可能出现错误 比如说宕机什么的，现在要你设计一个协议去保证这个大文件的传输，那么这个协议你要如何设计，简单的讲一讲？（很经典的一个大文件上传、断点续传）

#### 2、那么发送端要如何知道还有哪些文件段还没发呢？（暗示我的协议缺陷，没有给确认号，但给了不就是类似滑动窗口了？爷不想用滑动窗口，所以还在想别的办法，但他就是想把我拉到滑动窗口）

#### 3、说我想得太复杂了，这不就很类似于滑动窗口吗？（我就是不想用滑动窗口啊！）

#### 4、说一下滑动窗口的执行流程（这才是你的最终目标吧面试官？）



### 4、Mysql

#### 4.1 了解事务的特性吗（常规八股）

#### 4.2 你刚才说到了原子性、一致性、隔离性，能具体说明一下是怎么一回事吗？举一下实际的例子（转账例子用一辈子）

#### 4.3 刚才说到了隔离性，你知道mysql的最高隔离级别是如何实现的吗？（常规八股）

### 场景题（结合了操作系统）

#### 1、如果要你来实现mysql的最高隔离级别，你会如何实现呢？具体说一下场景、具体的语句，要分别如何加锁，加什么锁？（仍然用转账来说明，A给B转账，B给A转账）

#### 2、你觉得你刚才说的这种场景会发生死锁问题吗？具体会发生在哪里呢？（转账是有流程的，先当前读自己账户余额，再当前读对方用户余额，再更改账户余额，具体死锁在哪你们自己想）

#### 3、要如何解决这种死锁的情况，在代码中要如何编写？（其实我觉得如果根据mysql的锁机制就一定会死锁，不管顺序如何，只要同时转账就会死锁；最后他让我不考虑mysql的锁机制，只考虑普通的锁，那就是操作系统的经典场景）

这里是我当时对场景没有思考得太清楚，同时开启转账事务的时候，如果当前读加的是读锁，则死锁会发生在更改余额那里；如果当前读加的是写锁，则读的时候就会发生死锁了，本质上还是操作系统的经典死锁问题，（我太笨比了）



### 5、操作系统

#### 5.1 逻辑地址、虚拟地址、物理地址、线性地址，他们之间分别有什么区别？它们之间是如何转化的？（说实话逻辑地址这个概念实在太模糊了）



应该是没有了，记不起来了，忘了录音

### 6、算法题

#### 1、检测循环依赖（其实很简单，但没复习拓扑排序，换了道题）

#### 2、将一棵二叉树根据中序遍历的顺序，转化为一个双向链表（左指针 = 链表的前向指针；右指针 = 链表的后向指针）











论坛项目如果帖子允许大家一起在线编辑，怎么控制并发

-- 回答了乐观锁，我说服务器返回给客户端数据中包含一个版本号

-- 问版本号保存在哪，我说是放在html的隐藏域中，实际上他想让我回答数据库表中有一个版本号字段

-- 还有什么实现方案？

-- 加锁，让一个帖子的编辑串行化执行

-- 应该加什么锁？

-- 分布式锁，讲了mysql、redis

-- 打断，如果一个用户进去编辑页面又退出来，怎么保证锁是可重入

-- 面试官想让我继续讲redis的分布式锁怎么实现可重入，我想到了在生成一个随机的uuid时保存在一个map中，用户id作为key，uuid作为值，加锁时先判断map中有没有用户id，有的话，取出uuid判断锁的值是不是这个。。。还是得查一下

怎么记录访问服务的日志？

-- spring aop

-- 又问我怎么记录访问数据库、redis服务的耗时时间的日志？

-- 我说疑惑，没有好方法

-- 他说可以用你刚才提到的aop呀，只要poincut的定义能包裹住要访问的数据库、缓存服务，在前后记录时间？？？好像是这样，我以为要排除我说过的方法。

《数据库相关》

高考成绩，学生来自一个省、一个市、一个学校、一个班级，每个课程的成绩怎么保存

-- 每个学校一个表 - 每个市一个表，数据量都太小了

-- 按照每个省一个表，一千万学生，七个课程，课程成绩表有七千万数据怎么分表

被前面问蒙了，八股都不会了

mysql的隔离级别

--可重复读怎么实现的

-- mvcc是什么

怎么排查kafka的消息积压问题（面试官把积压连着一起读的好快，ji~ya -> jia，我内心什么是消息加问题，面试官复述了几遍消息加~消息加~消息加，没看过消息队列的八股，一时get不到www）





18、线程池的核心参数是什么？

19、如果线程池核心线程数设置为5，最大线程数设置为10，阻塞队列是一个无界队列，一直提交线程，线程数最大能达到多少？

20、如果线程池核心线程数设置为5，最大线程数设置为10，阻塞队列大小也设置的是10，线程池刚启动的时候有多少个线程？

21、看过Java线程池的源码吗？如果想监控线程池的资源，通过看它的源码，它有没有提供什么方式来实现这个功能？

22、redis部署的是单机还是集群？

23、redis哨兵模式和集群模式分别是用来解决什么问题的？

24、集群模式当获取数据时，可能会回复asyn、moved，了不了解这些回复分别代表什么？（不了解。。。）

25、使用集群模式的话会有什么限制吗？（不同节点上的数据无法使用事务）

26、如果想使用事务操作的话，希望key能分布在一个节点上，有没有什么办法可以让key分布在同一个节点上？（redis提供了这样的功能hashtag）

27、redis用到了哪些数据结构？

28、zset的底层数据结构有没有了解过？

29、为什么zset要在数据比较小的时候使用压缩列表呢，压缩列表是一个什么样的数据结构，能带来什么好处呢？

30、redis的rehash有了解过吗，是怎么进行rehash的？

31、Java线程有哪几种状态，以及状态之间如何转换的？

32、线程中断有没有了解过？

33、Java中的原子类是怎么实现的知道吗？

34、volatile关键字有什么特点，原理是什么？

35、Java中有什么无锁操作的方式？

36、ThreadLocal的基本原理是什么？

37、Java的泛型了解吗？

38、如果有两个类，一个animal，一个dog，dog继承于animal，现在有一个animallist，它的泛型是animal，然后有个doglist，泛型是dog，doglist能不能赋值给animallist？不能

39、说说数据库的索引

40、聚簇索引和非聚簇索引能介绍一下吗？

41、哪些类spring会帮我们管理呢？

42、配置了@Service就一定会放入bean中吗？有没有什么条件？

43、如果第三方jar包中有一个@Service，会被扫描进来吗？

44、第三方jar包要想被扫描进来的话是要将它的类路径加载进spring是吗？

45、第三方jar包如何保证spring会将它加载进spring中？

46、Spring中为什么要将bean交给Spring来管理？

47、如果我自己弄一套Controller、Service、Dao，不依赖spring容器，能不能work，这个过程应该怎么写知道吗？不知道。。。

48、PrepareStatement预编译的过程是在哪里？

49、为什么使用statement会有SQL注入的风险呢？

50、如果有一个SQL语句，我想进行SQL注入攻击，应该怎么样攻击，怎么样设计SQL语句？

51、Spring的bean通常会new多少个对象，比如userService是每一个请求来了就new一个userService还是全局共享一个userService？

52、就拿这个userService来说，假设里面有个一个getUserById的方法，那应该把这个userService的scope设置成单例的还是session的？singleton，因为一般来说service和dao都是无状态的，只是通过service和dao来操作数据库，使用session或者prototype的话也可以，只是会浪费资源。

53、如果在线程池中的task中出现了没有捕获的异常会对当前线程有什么影响？对线程池有什么影响？

54、如果出现上面这种异常应该对线程进行什么处理呢，线程池应该怎么处理呢？

55、做前后端分离的时候，你项目里前端登录状态是怎么保持的？

56、有没有其他更好的方式？（jwt）

57、为什么使用cookie会导致csrf攻击？

58、为什么使用jwt能避免csrf攻击呢？

59、在goole域名中查看baidu域名的cookie能查看到吗？

两位面试官应该都是资深的技术工程师，都非常nice，两个人一共问了一个半小时，人都被问麻了，而且问的东西也比较广比较深，基本是问到不懂为止。

![img](https://uploadfiles.nowcoder.com/images/20191019/6658561_1571455041360_4A47A0DB6E60853DEDFCFDF08A5CA249)

## 二面

二面忘记录音了。。。

就只写一些还记得住的东西吧。

大概就是把项目都过了一遍，然后项目里的东西延伸着问了一些

1、问的第一个项目是实验室的DDOS相关的项目，让自己讲了一遍项目的内容。然后项目细节问了一些东西，再延申了一下DDos方面的问题

2、DDOS攻击有哪些，以及原理是什么？

3、防御DDOS攻击的手段有什么？

4、第二个项目也是实验室的一个项目，问了一些项目细节

5、第三个是自己写的一个交流社区的项目，在网络安全方面应该如何考虑设计以及实现。（防sql注入、csrf攻击）

6、spring的权限管理步骤是什么？

7、spring的拦截器是什么设计模式？

8、讨论了一下保证缓存和数据库数据一致性的问题。

9、jwt的认证过程是什么？

9、第四个是一个rpc项目，没怎么问。

大概只记得这些东西，其他具体的记不清了😥