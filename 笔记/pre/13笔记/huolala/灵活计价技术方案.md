# 灵活计价技术方案

# 1. 技术方案概要说明

## 需求

> [【货运】微面灵活计价1.0](https://huolala.feishu.cn/wiki/wikcnNGpk8tlPZGNQEM7TMNEUCf) 
>
> [【灵活计价1.0】 工程需求](https://huolala.feishu.cn/docs/doccnPQaNBhtDA043wUszK0Wl3e) 
>
> 影响业务线：
>
> - 小B

## 技术方案设计目标

> 1. 打通多因素与灵活计价体系。

## 技术方案业界调研

> 不涉及

## 技术方案生命周期

> 长期

## 技术方案整体架构设计

暂时无法在飞书文档外展示此内容

- 算法离线策略，每天凌晨同步最新的全量数据到sprs服务

- 计价携带多因素调价信息，调用sprs服务，获取最终的多因素调价信息。

- sprs服务，结合在线算法策略以及离线策略得到最终的调价结果，返回计价

# 2. 服务详细设计

## 时序图

- 估价时序图

![img](https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWQwMGFiNzIxOGEzMDE3ZmI5MjBlMjFkZDExZWViYTJfdnFEMEdFM3R0WjZDY1ZERFRwakdxMkgxZ2pWUjU5b1NfVG9rZW46Ym94Y253UzF1WU9NWmtUeHlnMUZ5UEgwalliXzE2Njk2MzgxNTg6MTY2OTY0MTc1OF9WNA)

## 流程图

### 2.1灵活计价流程图

暂时无法在飞书文档外展示此内容

**补贴定价调和系统决策平台相关：**

- baseDynamicPricing 策略，配置上下限，以及埋点开关

```Go
begin

    // 只做维面
    if !in(nsVehicleID,"100,101")
    {
       
       return  
    }
    
    // 开城配置
   if !in(req.CityId,"1001,1002")
    {
       return 
    }
    
    //动态定价开关
    dynamicPricingSwitch=true


    if in(nsVehicleID,"100,101")
    {
        minRate=-0.1
        maxRate=0.2
    }


end
```

- **genAlgorithmID** 算法场景对应的id 策略

```Go
begin
    
    bucketIDs = append(bucketIDs, "v1")
    
    bucketIDs = append(bucketIDs, to_string(req.CityId))
    bucketIDs = append(bucketIDs, startFlexGridID)
    bucketIDs = append(bucketIDs, endFlexGridID)
    
    if in(nsVehicleID, "120,100,112") {
        bucketIDs = append(bucketIDs, "1")
    } else if in(nsVehicleID, "101") {
        bucketIDs = append(bucketIDs, "2")
    } else if in(nsVehicleID, "102,103,104,106,107,108,113,114") {
        bucketIDs = append(bucketIDs, "3")
    } else if in(nsVehicleID, "105,109,110,111") {
        bucketIDs = append(bucketIDs, "4")
    } else {
        bucketIDs = append(bucketIDs, "-1")
    }

    if hour >= 6 && hour < 9 {
        bucketIDs = append(bucketIDs, "1")
    } else if hour >= 9 && hour < 12 {
        bucketIDs = append(bucketIDs, "2")
    } else if hour >= 12 && hour < 15 {
        bucketIDs = append(bucketIDs, "3")
    } else if hour >= 15 && hour < 18 {
        bucketIDs = append(bucketIDs, "4")
    } else if hour >= 18 && hour < 21 {
        bucketIDs = append(bucketIDs, "5")
    } else if hour >= 21 && hour < 24 {
        bucketIDs = append(bucketIDs, "6")
    } else {
        bucketIDs = append(bucketIDs, "-1")
    }

    if distance >= 0 && distance < 1000 {
        bucketIDs = append(bucketIDs, "6")
    }  else {
        bucketIDs = append(bucketIDs, "-1")
    }
end
```

- dynamicPricing 策略

```Go
begin

//灵活计价系数=0 直接返回
if (strategyInfo.adjustCoeff == 0 ){
    return
}

//多因素和灵活计价调价方式不一样 ，则不灵活计价
if odAmount.coeffType!=strategyInfo.coeffType{
    return
}

//灵活计价调涨时，并且多因素是双低场景，则不调价
if strategyInfo.adjustType==2 && odAmount.DoubleDown{
   return
}


//系数方式 目前也支持这一种
if strategyInfo.coeffType==1{
    //系数累加
    odAmount.Rate = strategyInfo.adjustCoeff+odAmount.Rate
    //如果小于0 则调跌，判断下限
    if odAmount.Rate<0 &&  odAmount.Rate < minRate{
        odAmount.Rate = minRate
    }
    
       //如果大于0 则调涨，判断上限
    if odAmount.Rate>0 &&  odAmount.Rate > maxRate{
        odAmount.Rate = maxRate
    }
}

end
```

### 2.2 灵活计价离线策略的同步

每天凌晨全量同步t的数据到sprs，

Hive 表：di.

| 调价规则唯一id (algorithm_id)  strategy_type:C:V:O:D or dist:H | city_id | vehicle_type | O_index              | D_index    | dist_level | hour_level  | strategy_info                                                |
| ------------------------------------------------------------ | ------- | ------------ | -------------------- | ---------- | ---------- | ----------- | ------------------------------------------------------------ |
| 1:1001:1:1211001052:3:2                                      | 1001    | 微面包车     | 1211001052           | 1211001049 | 30,50      | 06:00,09:00 | [{adjust_type:1,score:0.7, adjust_rate:0.11, exp_info:2022-11-22-v1, effect_weeks:(1,3,5),eo_rate:0.3,rsp_rate:0.6,"is_offline":0},{adjust_type:2,score:0.3, adjust_rate:0.05, exp_info:2022-11-22-v2, effect_day:(2,4,6),eo_rate:0.4,rsp_rate:0.5,"is_offline":1}] |
| v2:1001:1:-1:1211001052:1                                    | 1001    | 微面包车     | -1（未找到灵活网格） | 1211001049 | 0,15       | 00:00,06:00 |                                                              |
| v3:1001:1:1211001052:1211001049:3                            | 1001    | 微面包车     | 1211001051           | 1211001049 | 50,80      | 09:00,12:00 |                                                              |

**strategy_info 策略信息：**

```Go
[
    {
        "adjust_type": 1,//1-调降，2-调涨；
        "coeff_type":1//1-系数，2-固定金额
        "adjust_coeff": 7,//调价系数*100 或者调价金额
        "effect_days": "1,3,5",//生效时间
        "is_offline": 0,
        "extend_info":{ //额外字段，埋点使用
                        "exp_info": "2022-11-22-v1", //数据版本
                        "eo_rate": 0.35672,
                        "rsp_rate": 0.91982
                      }
    
    },
    {
        "adjust_type": 1,
        "coeff_type":1
        "adjust_coeff": 0.05,
        "effect_days": "2,4,6",
        "is_offline": 0,
        "extend_info":{
                        "exp_info": "2022-11-22-v1",
                        "eo_rate": 0.5,
                        "rsp_rate": 0.8
                      }
    
    },
]
```

Kafka topic: ios_sprs_dynamic_pricing_strategy

Kafak msg结构:

```JSON
{
    "algorithm_id":"1:2:3:4:5"
    "strategy_info":"[{\"adjust_type\":1,\"coeff_type\":1,\"adjust_coeff\":7,\"effect_days\":\"1,3,5\",\"is_offline\":0,\"extend_info\":{\"exp_info\":\"2022-11-22-v1\",\"eo_rate\":0.35672,\"rsp_rate\":0.91982}},{\"adjust_type\":1,\"coeff_type\":1,\"adjust_coeff\":0.05,\"effect_days\":\"2,4,6\",\"is_offline\":0,\"extend_info\":{\"exp_info\":\"2022-11-22-v1\",\"eo_rate\":0.5,\"rsp_rate\":0.8}}]",//策略信息
    "dt":2020-11-11""
  }
```

## 接口文档

> [补贴定价调和系统接口文档](https://huolala.feishu.cn/wiki/wikcnU1SIJeEr8JmYgaYGocVDvf) 

- ## 存储

- - ###  MYSQL  

  - ###  REDIS

| **用途**       | **类型** | **key**          | **字段结构**                                                 | **描述**                                                     | 过期时间 | 占用内存大小                   |
| -------------- | -------- | ---------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | -------- | ------------------------------ |
| 用于核价时监控 | string   | ios:sprs:dy:p:%s | {        "source_od_amount": {                "amount": 99,                "rate": 0.99,                "adjust_type": 0,                "double_down": true,                "from_grid_code": "",                "to_grid_code": "",                "grid_type": 0,                "grid_level": 0        },        "strategy_info": {         "adjust_type": 1,         "coeff_type":1         "adjust_coeff": 0.07,         "effect_days": "1,3,5",         "is_offline": 0,         "extend_info":{                         "exp_info": "2022-11-22-v1",                         "eo_rate": 0.35672,                         "rsp_rate": 0.91982                       }    },       "dst_od_amount": {                "amount": 99,                "rate": 0.99,                "adjust_type": 0,                "double_down": true,                "from_grid_code": "",                "to_grid_code": "",                "grid_type": 0,                "grid_level": 0        },} | 存储一次估价的详情信息。包括基础信息、OD价格信息、附加费信息 | 3分钟    | 400B*3*2*60*500 =83340000B=80M |

### ES

无

- ## 性能评估

- - ###  性能分析

> 设计QPS = 1000
>
> 估价rt < 50ms

### 监控&限流、熔断

> 增加metric埋点，监控灵活计价的调价系数均值、灵活计价的覆盖面、

### 技术方案日志要求

> 日志保存12天

### 技术运营评估与实施

> 不涉及

### 资源消耗

> 3台ECS机器，cpu<20%, mem <30%

- ## 容灾分析

- - ###  安全架构

>  不涉及

### 兼容与部署要求

> 不涉及

### 数据迁移方案

> 不设计