【灵活计价1.0】 工程需求

1. # 策略介绍

用于评估方案是否可迁移至线上计算

> **策略场景**

- > 城市、车型、起点灵活网格、终点灵活网格 or 里程、时段

> **策略组成**

> 调价分数=估转分数*弹性分数/总分数

## 1.1 估转分数

> 统计场景历史上一定周期的估转率

- > 计算较为灵活：过去一个月、过去两个月，需要避开节假日等特殊日期；

**估转分数：**

- $$0,0.3 \rightarrow 6；0.3,0.4 \rightarrow 5 ；0.4,0.5 \rightarrow 4；0.5,0.6 \rightarrow 3；0.6,0.7 \rightarrow 2；0.7,+inf \rightarrow 1$$

## 1.2 弹性分数

> **估转弹性**：单位附加费系数下估转率下降幅度；

- > 统计场景历史上一定周期的估转弹性，再将全国场景弹性按订单量加权排序得到；

> **弹性分数**=城市内部场景弹性排序分数+全国城市弹性排序分数

**估转弹性计算与城市内部场景弹性排序举例：**

- 第一步：特征底表
  - 获取场景下不同用户估价下单数据，以及对应的附加费系数

城市id车型O灵活网格id时段user_id附加费系数行为城市id车型O灵活网格id时段user_id附加费系数行为1001微面包车121100105206:00,09:0010.2估价又下单1001微面包车121100102006:00,09:0020.2估价1001微面包车121100105206:00,09:0020.2估价1001微面包车121100102006:00,09:0030.2估价1001微面包车121100105206:00,09:0030.2估价1001微面包车121100102006:00,09:0040.2估价1001微面包车121100105206:00,09:0010.1估价又下单1001微面包车121100102006:00,09:0020.1估价又下单1001微面包车121100105206:00,09:0030.1估价又下单1001微面包车121100102006:00,09:0040.1估价又下单1001微面包车121100105206:00,09:0040.15估价又下单1001微面包车121100102006:00,09:0050.1估价又下单1001微面包车121100105206:00,09:0020.15估价1001微面包车121100102006:00,09:0030.15估价1001微面包车121100105206:00,09:0050.15估价又下单1001微面包车121100102006:00,09:0060.15估价又下单

- 第二步：特征构建
  - 获取场景不同附加费系数下的估转率

城市id车型O灵活网格id时段附加费系数估转率城市id车型O灵活网格id时段附加费系数估转率1001微面包车121100105206:00,09:000.111001微面包车121100102006:00,09:000.111001微面包车121100105206:00,09:000.150.671001微面包车121100102006:00,09:000.150.51001微面包车121100105206:00,09:000.20.331001微面包车121100102006:00,09:000.20

- 第三步：最小二乘法拟合直线 计算场景弹性

城市id车型O灵活网格id时段弹性城市id车型O灵活网格id时段弹性1001微面包车121100105206:00,09:00-6.666671001微面包车121100102006:00,09:00-10

- 第四步：按场景订单量加权排序弹性 得到弹性分数
  - 估转弹性降序排序，分数依次为3、2、1分，订单占比分别是：1:3:1

（为了更好的说明逻辑，新增了数据）

城市id车型O灵活网格id时段弹性单量弹性分数1001微面包车121100102509:00,12:00-211030-1201001微面包车121100104015:00,18:00-43002120-4801001微面包车121100103409:00,12:00-81001480-6001001微面包车121100102006:00,09:00-104011001微面包车121100105206:00,09:00-6.66667501

1. # 策略交互

## 2.1 策略场景配置化

> 通过决策平台完成策略场景配置

> 示例：

> ![img](https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmI2ZDQ5ZDY3Y2YxYmNiMTdkNjc1Yjg3MGVjYzEzZGVfUWNKOGdXZm5JWWVuRE8xU1B4VGFsa2dCTFRpeEZMY09fVG9rZW46Ym94Y25WTW1aVmp6WkZuRFNTN04zeUdlU1BoXzE2Njk2MzgzOTE6MTY2OTY0MTk5MV9WNA)

各场景分桶兜底值均为"-1"

- 策略版本：
- **城市 C**：229个落地城市，每桶id为city_id；
- **灵活网格 起点O、终点D**：12000+，每桶id为灵活网格id；
- **车型 V**：1桶（1.0只做微面）

无法复制加载中的内容

- **时段 H**：7桶、**里程 dist**：5桶

无法复制加载中的内容

## 2.2 策略获取

**方式一**：**Hive** **to Kafka**

- 每日例行策略hive表，并同步到Mysql+Redis；

- strategy_info: 

  落

  埋点

  - 计算调价系数相关
    - adjust_type, 调价类型，1-调降，2-调涨；
    - coeff_type, 调价方式：1-系数，2-固定金额
    - score, 调价分数，精度：小数点后五位；  
    - adjust_coeff: 调价系数，精度：小数点后五位(可改)
    - effect_day: 上线日期
    - is_offline: 是否下线
  - 算法落埋点数据
    - exp_info：实验批次信息；eo_rate：场景估转率, rsp_rate: 场景响应率; score: 场景调价分数

```JSON
[
    {
        "adjust_type": 1,
        "coeff_type":1
        "adjust_coeff": 0.07,
        "effect_days": "1,3,5",
        "is_offline": 0,
        "extend_info":{
                        "exp_info": "2022-11-22-v1",
                        "eo_rate": 0.35672,
                        "rsp_rate": 0.91982
                      }
    
    },
    {
        "adjust_type": 1,
        "coeff_type":1
        "adjust_coeff": 0.05,
        "effect_days": "2,4,6",
        "is_offline": 0,
        "extend_info":{
                        "exp_info": "2022-11-22-v1",
                        "eo_rate": 0.5,
                        "rsp_rate": 0.8
                      }
    
    },
]
```

- 决策平台工作
  - 支持离线、时空分流；
  - 配置兜底调价系数上限；
  - 支持灵活计价系数强制置0，系数随机功能；
  - 临时上下线部分OD情况
    - 解决方法一：将下线OD导入默认不生效分组，或重新导入实验OD名单
      - 因为有对照组和强制不生效操作，需要调价金额强制置0功能；
    - 解决方法二：策略表输出层增加是否上下线标识
      - is_offline:1-下线，0-上线；增加在strategy_info

无法复制加载中的内容

- **优点**
  - 算法册调整策略计算逻辑灵活；
  - 离线的弹性特征不适合线上计算；
- **不足**
  - 存在数据丢失风险，但比例可接受。



**方式二**：**线上计算**

- **优点**
  - 避免数据丢失；
- **不足**
  - 灵活计价属于中长期调价，子场景特征均采用离线计算方式，一批实验上线期间数据不变；
  - 场景弹性值计算后，需与相同城市内其它场景弹性以及全国城市弹性 排序得到排序分数，且不同分数设有一定订单比例，该过程无法线上完成；
  - 如果由算法册同步排序结果，那么等同于同步最终分数。



1. # 调价系数计算

- 上限

  - 默认多因素与灵活计价的叠加系数上限为 30%（上调、下调上限一致）；工程侧做
  - 金额上限（计价有，国标车型粒度）；计价侧做

- 起步价的单不建议下调，当前多因素是否有调？

  yes;计价册有

  - 多因素里有兜底，调后价格<起步价，调价不生效（标为不是多因素），返回原价；
    - 如原价35，多因素调后28，多因素不生效，返回35；
    - 调和：调附加费调和前，是否就有上面的判断 yes;

- 调价系数叠加公式

  - **多因素和灵活计价都是系数**: 最终调价系数=多因素系数+灵活计价系数（注意符号，存在同涨、同降、一涨一降的情况）

  - **多因素和灵活计价都是固定金额**: 最终调价金额=多因素金额+灵活计价金额（注意符号，存在同涨、同降、一涨一降的情况）

  - 多因素和灵活计价调价方式

    **不一致，直接返回多因素调价**

    ，

    - 命中多因素固定金额，灵活计价系数：直接返回多因素固定金额；
    - 命中多因素系数，灵活计价固定金额：直接返回多因素系数；



1. # 调和问题

- 调涨时，如果命中多因素双低场景名单，则不涨价；
- 调降不管。

# 

备注

- 计价有核价
  - 城市车型里程用户OD系数
  - 随机的时候不按用户粒度

核价问题：

核价失败：多因素变了，前后叠加系数不一致

- 估价：多因素10，灵活计价5，返回15
- 核价：多因素12，灵活计价5，返回17

核价成功：多因素变了，应该是核价失败的，但成功了

- 估价：多因素10，灵活计价20， 返回30
- 核价：多因素12，灵活计价20，返回 30 （32超出上限）
- 核价：多因素9，灵活计价20，返回 29 

缓存什么？

- 缓存最终叠加系数不建议，紧急下线后，仍然会有调价；
- 缓存灵活计价系数



识别估价、核价，看不加缓存是否有问题

算法侧不要在估价粒度做随机，不要频繁变，增加核价失败概率；



- 计价每次重新算多因素，可能会前后系数不一样，那工程返回后的叠加系数也会不一样，导致核价失败
  - 工程只缓存灵活计价结果；避免灵活计价前后系数不一样，但叠加系数也会不一样；
  - 返回缓存的叠加系数