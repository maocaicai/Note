智能决策管理平台设计方案



| **文档版本** | **作者** | **版本**  | **更新日志** | **技术文档编写工时** | **审核人** | **审核意见** |
| ------------ | -------- | --------- | ------------ | -------------------- | ---------- | ------------ |
| v1.0         | 蒋元恒   | 2021.8.10 |              |                      |            |              |

1. # 技术方案概要说明

- ## 需求

实现智能营销业务的平台化，包括业务自动化、调参自动化，算法仿真，实现算法和工程解耦，算法对策略负责，工程对平台负责。

- ## 技术方案设计目标

实现智能营销系统的特征管理、规则管理、策略管理、流量管理、模型管理、任务管理。

- ## 技术方案业界调研

不涉及

- ## 技术方案生命周期

长期

- ## 技术方案整体架构设计

![image-20221128203137626](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128203137626.png)

1. MySQL用于存储特征、规则、策略、任务等配置数据，文件存储服务用于.model模型文件的版本管理。
2. Consul用于任务验证后发布时的多服务实例服务发现。
3. 规则、策略、流量的配置需UFS和IRS等业务方配合逻辑实现。

1. # 服务详细设计

## 时序图

![img](https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=YmIzYTljNWY0MTgzYzZlNDE4YWQ4Y2E2YzQ3ZTBiODlfUG1kcFNndUZVSlVHQ1p5ZGtmZVN4ZHVmUmc4M0Rqdm9fVG9rZW46Ym94Y25HQzU1Tm81bUJ3dm40ZWI0SUFwMEhYXzE2Njk2Mzg2NTk6MTY2OTY0MjI1OV9WNA)

- ## 流程图

### 智能决策管理平台操作流程

![image-20221128203219632](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128203219632.png)

### 模型管理

- #### 模型上传流程

![image-20221128203235379](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128203235379.png)

1. 模型文件以模型名称为标识，每个模型可存储多个版本，可在多个版本间切换
2. 模型文件上传在模型管理功能模块中，模型的验证和发布，在任务管理功能模块中

- #### 模型文件验证流程

![image-20221128203248083](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128203248083.png)

注：模型文件的验证在管理平台本系统完成。

**模型验证（仿真环境）、发布、回退逻辑整合在任务管理中，不单独提供模型的发布、回退**

### 任务管理

- #### 任务验证、发布时序图

![image-20221128203300054](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128203300054.png)

- #### 任务状态流转图

![image-20221128203309450](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128203309450.png)

##### 

#### 任务验证、发布流程图

![image-20221128203321377](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128203321377.png)

注：

1. *智能决策管理平台下发发布命令后，如果所有服务实例加载完成，是否需要再次通知所有服务实例删除上一个版本。*

如果发布到某个实例失败，那么再次发送回滚指令仍然可能会失败，因此，不做自动回滚的设计，做告警提示，研发做技术支持。

#### 任务回滚流程图

![image-20221128203350683](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128203350683.png)

##### 模型文件发布流程

模型文件的发布是嵌入到任务发布过程中（包括仿真环境和线上环境）

1. 服务方收到任务结构数据中的模型文件URL后从OSS拉取文件
2. 校验模型文件的MD5值
3. 加载到内存

##### 模型文件回退流程

模型文件的回滚是嵌入到任务回滚过程中（包括仿真环境和线上环境）

1. 自动触发的回滚，无需指定回滚版本，默认恢复到上一个生效的版本
2. 回滚命令下发后，也需要服务方回调通知管理平台是否回滚成功

- #### 仿真、发布总体框架图

无法复制加载中的内容

注意：模型、任务需要增加**MD5校验**防止文件传输不全。

### 用户权限控制

1. 用户的权限点分为：接入系统（app_id），接口。
2. 操作类型分为：查看、新增、编辑、验证、发布、删除。
3. 用户角色：超级管理员，业务系统管理员，普通用户
   1. 普通用户：仅可查看本系统相关特征、规则、模型、分流实验、任务等数据，可新增、编辑、发布、删除本业务系统相关记录。
   2. 业务系统管理员：可查看、新增、编辑、发布、删除本系统业务数据记录。
   3. 超级管理员：可对本系统内所有记录做增删改查的操作，并负责审批用户的权限申请。
4. 接口的middleware层对所有接口调用做UAC校验。![image-20221128203416629](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128203416629.png)

1. **对规则、策略等数据记录的每一次操作都会产生详尽的log记录，并插入操作记录表，包含操作时间、动作类型、操作人、调用接口的请求参数、接口返回结果等内容，方便审计。**

## 仿真、线上环境日志查看，数据报表

> TODO

- ## 接口文档

[接口文档定义](https://huolala.feishu.cn/wiki/wikcntaS8Pky1e7eYeBxZVjvtdf#sP89YA) 

- ## 存储

  - ### MYSQL

```SQL
//  特征表
CREATE TABLE IF NOT EXISTS `feature` (
    `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '特征ID，自增主键',
    `feature_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '特征ID',
    `feature_name` varchar(255) NOT NULL DEFAULT '' COMMENT '特征名称',
    `app_id` varchar(128) NOT NULL DEFAULT '' COMMENT '使用方APPID',
    `api` varchar(128) NOT NULL DEFAULT '' COMMENT '使用方接口名',
    `use_type` tinyint(1) NOT NULL DEFAULT '0' COMMENT '使用类型：1-输入，2-输出',
    `type` tinyint(1) NOT NULL DEFAULT '0' COMMENT '特征类型：1-int，2-float，3-string，4-struct，5-function',
    `state` tinyint(1) NOT NULL DEFAULT '0' COMMENT '特征状态：0-未使用，1-使用中，2-已废弃',
    `property` json NOT NULL COMMENT '其他扩充属性',
    `description` text NOT NULL DEFAULT '' COMMENT '特征描述',
    `is_deleted` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否删除：0-未删除，1-已删除',
    `creator` varchar(64) NOT NULL DEFAULT '' COMMENT '创建人',
    `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',    
    PRIMARY KEY (`id`),
    UNIQUE KEY `ft_feature_id` (`feature_id`),
    UNIQUE KEY `ft_feature_name` (`feature_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='特征';

//  规则表
CREATE TABLE IF NOT EXISTS `rule` (
    `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '规则ID',
    `rule_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '规则ID',
    `rule_name` varchar(255) NOT NULL DEFAULT '' COMMENT '规则名称',
    `app_id` varchar(128) NOT NULL DEFAULT '' COMMENT '使用方APPID',
    `api` varchar(128) NOT NULL DEFAULT '' COMMENT '使用方接口名',
    `used_feature` json DEFAULT NULL COMMENT '规则包含的特征ID集合',
    `definition` text NOT NULL DEFAULT '' COMMENT '规则的具体定义',
    `state` tinyint(1) NOT NULL DEFAULT '0' COMMENT '规则状态：0-未使用，1-使用中，2-已废弃',
    `property` json DEFAULT NULL COMMENT '其他扩充属性',
    `description` text NOT NULL DEFAULT '' COMMENT '规则描述',
    `is_delete` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否删除：0-未删除，1-已删除',
    `creator` varchar(64) NOT NULL DEFAULT '' COMMENT '创建人',
    `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `rl_rule_id` (`rule_id`),
    UNIQUE KEY `rl_rule_name` (`rule_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='规则';

//  策略表
CREATE TABLE IF NOT EXISTS `strategy` (
    `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '策略ID，自增主键',
    `strategy_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '策略ID',
    `strategy_name` varchar(255) NOT NULL DEFAULT '' COMMENT '策略名称',
    `app_id` varchar(128) NOT NULL DEFAULT '' COMMENT '使用方APPID',
    `api` varchar(128) NOT NULL DEFAULT '' COMMENT '使用方接口名',
    `priority` int(10) NOT NULL DEFAULT '0' COMMENT '策略优先级',
    `definition` text NOT NULL DEFAULT '' COMMENT '规则的具体定义',
    `used_feature` json DEFAULT NULL COMMENT '策略包含的特征ID集合',
    `start_valid_time` datetime NOT NULL COMMENT CURRENT_TIMESTAMP COMMENT '开始生效时间',
    `end_valid_time` datetime NOT NULL COMMENT CURRENT_TIMESTAMP COMMENT '结束生效时间',
    `state` tinyint(1) NOT NULL DEFAULT '0' COMMENT '规则状态：0-未使用，1-使用中，2-已废弃',
    `property` json DEFAULT NULL COMMENT '其他扩充属性',
    `description` text NOT NULL DEFAULT '' COMMENT '策略描述',
    `is_delete` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否删除：0-未删除，1-已删除',
    `creator` varchar(64) NOT NULL DEFAULT '' COMMENT '创建人',
    `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `st_strategy_id` (`strategy_id`),
    UNIQUE KEY `st_strategy_name` (`strategy_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='策略';


// 模型表
CREATE TABLE IF NOT EXISTS `model` (
    `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '模型ID',
    `model_name` varchar(255) NOT NULL DEFAULT '' COMMENT '模型名称',
    `app_id` varchar(128) NOT NULL DEFAULT '' COMMENT '使用方APPID',
    `api` varchar(128) NOT NULL DEFAULT '' COMMENT '使用方接口名',
    `model_type` int(10) NOT NULL DEFAULT '0' COMMENT '模型类型，例如xgboost',
    `versions` json COMMENT '模型版本ID列表',
    `current_version` int(10) NOT NULL DEFAULT '0' COMMENT '当前生效版本id',
    `description` text NOT NULL COMMENT '模型描述',
    `state` tinyint(1) NOT NULL DEFAULT '0' COMMENT '模型状态：0-未使用，1-使用中',
    `property` json DEFAULT NULL COMMENT '其他扩充属性',
    `is_deleted` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否删除：0-未删除，1-已删除',
    `creator` varchar(64) NOT NULL DEFAULT '' COMMENT '创建人',
    `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_model_name` (`model_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='模型';

// 模型历史版本表
CREATE TABLE IF NOT EXISTS `model_version` (
    `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '模型文件ID', 
    `app_id` varchar(128) NOT NULL DEFAULT '' COMMENT '使用方APPID',
    `api` varchar(128) NOT NULL DEFAULT '' COMMENT '使用方接口名',
    `model_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '版本所属的模型ID',
    `oss_url` varchar(255) DEFAULT '' COMMENT '存储在oss的资源名称',
    `ver_name` varchar(64) NOT NULL DEFAULT '' COMMENT '版本号',
    `md5` varchar(128) NOT NULL DEFAULT '' COMMENT '模型文件md5值',
    `ver_desc` varchar(64) NOT NULL DEFAULT '' COMMENT '版本描述',
    `is_deleted` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否删除：0-未删除，1-已删除',
    `creator` varchar(64) NOT NULL DEFAULT '' COMMENT '创建人',
    `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_ver_name` (`ver_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='模型文件版本';

//分流实验表
CREATE TABLE IF NOT EXISTS `flow` (
    `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '自增主键',
    `flow_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '分流实验ID',
    `flow_name` varchar(255) NOT NULL DEFAULT '' COMMENT '分流实验名称',
    `app_id` varchar(128) NOT NULL DEFAULT '' COMMENT '使用方APPID',
    `api` varchar(128) NOT NULL DEFAULT '' COMMENT '使用方接口名',
    `used_rule` json DEFAULT NULL COMMENT '实验包含的规则ID集合',
    `description` text NOT NULL DEFAULT '' COMMENT '实验描述',
    `start_valid_time` datetime NOT NULL COMMENT CURRENT_TIMESTAMP COMMENT '开始生效时间',
    `end_valid_time` datetime NOT NULL COMMENT CURRENT_TIMESTAMP COMMENT '结束生效时间',
    `state` tinyint(1) NOT NULL DEFAULT '0' COMMENT '规则状态：0-草稿，1-使用中，2-已废弃',
    `property` json DEFAULT NULL COMMENT '其他扩充属性',
    `is_delete` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否删除：0-未删除，1-已删除',
    `creator` varchar(64) NOT NULL DEFAULT '' COMMENT '创建人',
    `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `fw_flow_id` (`flow_id`),
    UNIQUE KEY `fw_flow_name` (`flow_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='流量';

#任务表
CREATE TABLE IF NOT EXISTS `task` (
    `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '任务ID',
    `task_name` varchar(255) NOT NULL DEFAULT '' COMMENT '任务名称',
    `versions` json DEFAULT NULL COMMENT '任务版本ID列表',
    `current_version` int(10) NOT NULL AUTO_INCREMENT COMMENT '当前任务版本ID',
    `app_id` varchar(128) NOT NULL DEFAULT '' COMMENT '使用方APPID',
    `api` varchar(128) NOT NULL DEFAULT '' COMMENT '使用方接口名',
    `description` text NOT NULL DEFAULT '' COMMENT '任务描述',
    `state` tinyint(1) NOT NULL DEFAULT '0' COMMENT '任务状态：0-草稿，1-仿真环境加载中，2-已发布仿真环境，3-线上环境加载中，4-使用中，5-已废弃',
    `property` json DEFAULT NULL COMMENT '其他扩充属性', 
    `creator` varchar(64) NOT NULL DEFAULT '' COMMENT '创建人',
    `deleted_at` datetime DEFAULT NULL COMMENT '删除时间',
    `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_task_name` (`task_name`),
    KEY `ix_updated_at` (`updated_at`),
    KEY `ix_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='任务';

# 任务版本表
CREATE TABLE `task_version` (
    `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '任务版本ID',
    -- `app_id` varchar(128) NOT NULL DEFAULT '' COMMENT '使用方APPID',
    -- `api` varchar(128) NOT NULL DEFAULT '' COMMENT '使用方接口名',
    `task_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '版本所属的任务ID',
    `version_name` varchar(64) NOT NULL DEFAULT '' COMMENT '任务名称',
    `version_desc` varchar(64) NOT NULL DEFAULT '' COMMENT '任务版本描述',
    `flow_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '分流实验ID',
    `group_actions` json NOT NULL COMMENT '流量实验不同分组对应的模型和策略',
    `model_ids` json NOT NULL COMMENT '任务中使用的模型ID列表',
    `strategy_ids` json NOT NULL COMMENT '任务中使用的策略ID列表',
    `is_deleted` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否删除：0-未删除，1-已删除',
    `creator` varchar(64) NOT NULL DEFAULT '' COMMENT '创建人',
    `deleted_at` datetime DEFAULT NULL COMMENT '删除时间',
    `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_version_name` (`version_name`),
    KEY `ix_updated_at` (`updated_at`),
    KEY `ix_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='任务版本';

# 任务发布表
CREATE TABLE `task_release` (

) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='任务发布表';
```

无分库分表操作



- ## 性能评估

  - ### 性能分析

内部算法、研发使用，QPS低于10

- ### 监控&限流、熔断

模型文件上传、任务验证失败、任务发布失败需加业务监控报警

- ### 技术方案日志要求

日志保留一周即可满足业务需求

- ### 技术运营评估与实施

不涉及

- ### 资源消耗

部署节点数：如需避免单点故障，两台机器即可满足。

MySQL存储空间消耗：待分析

- ## 容灾分析

  - ### 安全架构

不涉及

- ### 兼容与部署要求

不涉及

- ### 数据迁移方案

不涉及





📎 附件