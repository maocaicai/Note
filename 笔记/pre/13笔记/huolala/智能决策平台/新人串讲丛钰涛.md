附加费-丛钰涛

# 一、项目概要

## 项目背景

> 目前附加费规则由运营人工配置，基于经验决定“加多少”，无法确定“加多少”最合理。现计划由算法来决策“加多少”，生成智能附加费策略，目前已支持货运小车、大车、搬家的业务场景。

## 项目目标

> 根据ops平台设置的策略信息与算法决策共同进行估价操作，决定附加费的具体数值。

## 使用对象

> 主要为内部运营及开发人员

## 主要功能

1. 新增策略
2. 查询策略
3. 修改策略
4. 查询策略详情
5. 下线策略
6. 批量导入
7. 获取批量导入列表
8. 下载导入失败详情
9. 删除策略
10. 查看日志
11. 获取附加费

- ## 技术方案整体架构设计

暂时无法在文档外展示此内容





# 二、数据库表设计

![](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128204203474.png)![image-20221128204242967](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128204242967.png)

# 三、Redis缓存

> 缓存策略是否命中

> 缓存策略详情

> 缓存规则配置及规则详情

> OD规则，用户估价缓存

# 四、业务逻辑(Admin服务)

1. ## 新增策略

![img](https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=NDFhZWViZTU3NTAxMzI5NWE1ZjMyODAzOTFhZjE3MDVfcE12Ymx0c292a3VqaVZ4N2RhSTBRclpNM2FWbVBhaXhfVG9rZW46Ym94Y25uekNZWEZyZXZXVnJQakVjaFJHcW5kXzE2Njk2MzkyNjg6MTY2OTY0Mjg2OF9WNA)

![image-20221128204303458](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128204303458.png)

其中，Redis分布式锁保证同一时间只有一个策略新增，添加策略时开启了Mysql事务防止出现手动修改数据库的情况

1. ## 查询策略列表

![img](https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjcwZTAxMjlhYzU3MTlhMzIwZTAyMTEzNzY1OTE5NTJfZkhQaVd6Q25GOVdDOHp4M1NTTnljYWpZWjhBZ0FONHNfVG9rZW46Ym94Y241VFc5Z1RBTFVBaFRHNW83cEs1MkRkXzE2Njk2MzkyNjg6MTY2OTY0Mjg2OF9WNA)

![image-20221128204322653](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128204322653.png)

1. ## 策略详情

![img](https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=MzliZWVhYTk4OTY2NzMyNzBlOGU4NGE1OGQwMzRhOWFfM3ZhMjhFZm9pRlg1NjVma29Mdm9ZOGlVeGhHajJadWhfVG9rZW46Ym94Y24yZnhIZkZnMU1mY2ZLbDZhZHJOR1ZlXzE2Njk2MzkyNjg6MTY2OTY0Mjg2OF9WNA)

无法复制加载中的内容

1. ## 修改策略

![image-20221128204343674](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128204343674.png)

1. ## 下线策略

![image-20221128204355954](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128204355954.png)

1. ## 批量导入

> 批量导入时，会导入一个具有固定格式的excel表，然后会被导入到导入任务表中，在后续定时任务中每分钟自动将excel中的数据导入到策略表中

![img](https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=NGUxNTc0ZDViZWU1ODI1YjY1N2RkZDI4MGU3MDQ4MTJfblFVdzFBZXp1RzFKekVqc2xiSzVEcVhqNUNZRlN6enZfVG9rZW46Ym94Y25qQ3JraEpYZDFxSlQ5NEphWFQ2NjZmXzE2Njk2MzkyNjg6MTY2OTY0Mjg2OF9WNA)

无法复制加载中的内容

1. ## 获取批量导入列表

![img](https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTMwMDdlNTFlNjhlMjM2ZTMyMGY5NGRhNDFmOTJmY2RfbUJaQ2c2WGN3S2l0NTVVbG5TUkQwZ3ZBd3RkU0d2bkNfVG9rZW46Ym94Y25Kb1lYQXNCcDNRaHlyQklKSFRzdVFoXzE2Njk2MzkyNjg6MTY2OTY0Mjg2OF9WNA)

无法复制加载中的内容

1. ## 下载导入失败明细

无法复制加载中的内容

1. ## 策略删除

无法复制加载中的内容

这里加了for update是防止在查询需要删除的策略时其他线程在查找策略时查到了将要删除的策略，导致查询到了需要删除的策略，导致幻读。

1. ## 算法规则列表

无法复制加载中的内容

# 五、业务逻辑(Api服务)

1. ## 获取附加费

无法复制加载中的内容

# 六、cron定时任务

1. ## 自动更新策略上下线

![image-20221128204424053](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128204424053.png)

1. ## 自动导入数据表到策略表

### (1):从导入任务表导入到导入任务详情表

![image-20221128204457392](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128204457392.png)![image-20221128204505570](C![image-20221128204532513](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128204532513.png)

这里添加了一个2s的定时器的目的是为了延长分布式锁时间，防止插入数据时间太长导致分布式锁过期。

## (2):从导入任务详情表导入到策略表

无法复制加载中的内容

## 定时任务

1. > 策略的自动上下线。

2. > 数据详情表中的策略信息同步到策略表中。

3. > 车型和城市的关系map自动更新。一小时更新一次。

# 七、Kafka

> od对照处理利用Kafka消费

> 灵活网格算法规则利用Kafka消费

# 八、代码结构

无法复制加载中的内容

### 时序图

无法复制加载中的内容

### 使用的框架以及组件

| 框架名称 | 地址                              | 备注              |
| -------- | --------------------------------- | ----------------- |
| gin      | https://github.com/gin-gonic/gin  | web框架           |
| gorm     | https://gorm.io                   | 操作数据库        |
| go-redis | github.com/go-redis/redis/v8      | redis客户端       |
| redsync  | github.com/go-redsync/redsync/v4  | redis集群分布式锁 |
| cron     | github.com/robfig/cron/v3         | 定时任务          |
| logrus   | http://github.com/sirupsen/logrus | 日志              |

# 八、工作平台

| 代码仓库     | https://gitlab.huolala.cn/group-tech/Intelligent-operation/framework/hll_surcharge_service |
| ------------ | ------------------------------------------------------------ |
| 日志平台     | http://kibana2-search.huolala.work/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-15m,to:now))&_a=(columns:!(_source),filters:!(),index:'7e744db0-cf74-11ec-89cc-790677a18a9c',interval:auto,query:(language:kuery,query:''),senv:prd,sname:ios-surcharge-svc,sort:!(),stype:'php:daemon') |
| 发布平台     | http://lalaplat2.huolala.work/deploy/workspace/service#/workspace/service/detail/3064 |
| 监控平台     | https://monitor-v.huolala.cn/board/view/782                  |
| 产品运营平台 | https://ops2-stg.huolala.cn/surcharge_new/smart_surcharge.html |

# 九、TODO

\1. 批量导入 任务拆分问题。批量导入任务表时是否会影响同时导入到任务详情表

影响，第二次定时任务时如果第一次还没导入完成，第二次导入时会停在分布式锁中，直到第一次导入结束才会释放锁，然后第二次定时任务再加锁执行

\2. algorihtm_id 算法策略内从3. 调价率计算的策略内容4. 总共几个策略文件。先后顺序。

任务管理中心可用于添加任务，任务可以选择使用大车/小车，以及在灵活网格的基础上选择分组策略，然后在执行相关业务获取附加费时会根据选择的几个策略文件去执行。

详细的策略设置可以在策略管理中心设置，主要使用规则引擎将策略细节分离了出来，可以设置多个策略，并在任务中选择不同的策略组合来起到分流试验的作用。

\5. 存hive，埋点。

在所有操作执行完毕后，另起协程存hive

\6. 小车的策略判定、大车的策略判定。

小车获取算法id：首先会进行模糊匹配，执行匹配到的策略，然后根据算法id和灵活网格规则缓存，在redis缓存中获得调价分数

\7. 时间重叠的判断。

主要查询的是城市+车型策略表，因为需要根据具体城市id、车型id、围栏id来获得结果，在单独列出这三个字段的表中查询更快

\8. 车型问题。什么是订单车型，什么是国标车型。

订单车型是指业务下的车型，国标车型是后台管理时所选择的，所以在获取附加费时，需要先根据业务选择的订单车型将其转换为后台管理的相对应的国标车型，然后再获取国标车型信息

\9. 分流问题。Select。

先调用set注入可选择分流的参数，然后通过select方法选择流量分组

\10. 关于决策平台、自己去试着配一个任务。