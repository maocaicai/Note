附加费一期技术方案

| **文档版本** | **作者**  | **编写时间** | **更新日志** | **技术文档编写工时** | **审核人** | **审核意见** |
| ------------ | --------- | ------------ | ------------ | -------------------- | ---------- | ------------ |
| V1.0         | happy.cai | 2021.10.26   |              |                      |            |              |

1. # 技术方案概要说明

- ## 需求

> https://wiki.huolala.work/pages/viewpage.action?pageId=85814082

- ## 技术方案设计目标

> 满足附加费一期需求中全部需求点

- ## 技术方案业界调研

> 不涉及。

- ## 技术方案生命周期

> 长期

- ## 技术方案整体架构设计

![image-20221128203757882](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128203757882.png)



各功能点负责人：

![img](https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=NDllYjEzMTUxMzcwNTYzMDQ2NjM1YWRjYzM4MjA4ODFfODdoWVlpWU50NFZaUWNEalo3cVdsbGt0TVF5RFN3RE1fVG9rZW46Ym94Y252TkU1REFnYU5IRUdaSlFFN2dreHBiXzE2Njk2MzkwNTg6MTY2OTY0MjY1OF9WNA)

1. # 服务详细设计

- ## 需求评估



- ## 时序图

1. OPS后台，通过OPS后端进行鉴权，单点登录。OPS后端将请求透传到附加费admin服务。城市和国标车型信息由ops后台提供给ops前端。
2. 附加费Admin服务通过定时任务，进行策略的状态流转，以及同步缓存共附加费后端服务进行命中策略的功能实现。实现admin服务同api服务接耦，互不干扰。

![image-20221128203845444](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128203845444.png)![image-20221128203856467](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128203856467.png)

- ## 流程图

1. 后台策略的添加
   1. 方案一，通过获取所有在线的策略，并发遍历每个时间重叠的策略，判断是否有城市+车型重复。

![image-20221128203926151](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128203926151.png)

1. 定时任务，上线策略，策略下线，估价命中策略的缓存

每分钟执行一次，进行策略的上下线状态的变更。

![image-20221128203942792](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128203942792.png)

1. 判断是否命中策略的流程

定时任务每1min，去获取当前所有的在线的策略，然后将该w下的城市+车型作为rediskey 存入缓存中。估价时直接读取该redis key，拿到策略id，再读取策略缓存，判断策略是否还有效。有效则命中。

无法复制加载中的内容

1. 估价流程：

1 搬家业务暂时没有附加费

2 大车业务暂时没有附加费

无法复制加载中的内容



1. 核价流程：

有3min中内估价 直接返回缓存数据，无则重新计算

无法复制加载中的内容

1. 算法子场景配置的同步,OD配置的同步

每天从IDP中同步规则到Mysql+Redis，供明日使用。Redis后天过期。

![image-20221128204001865](C:\Users\mao'cai'cai\AppData\Roaming\Typora\typora-user-images\image-20221128204001865.png)



- ## 接口文档



[一期接口文档](https://huolala.feishu.cn/wiki/wikcnmtcgc9rJlSSV1Bp5aTYDwe#) 

- ## 存储

  - ### MYSQL

1. 策略的存储
   1. 方案一

```SQL
CREATE TABLE `strategy_cfg` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '自增主键',
  `name` varchar(100) NOT NULL  COMMENT '策略名称',
  `bussiness` tinyint(3) COMMENT '业务类型1 货运 2搬家',
  `status` tinyint(3) COMMENT '状态 0 未上线 1上线中 2下线',
  `city_ids`  varchar(200) NOT NULL COMMENT '城市id多个id逗号分隔',
  `city_names`  varchar(255) NOT NULL  COMMENT '城市名字多个名字逗号分隔',
  `ns_vehicle_ids` varchar(100) COMMENT '国标车型id，多个国标车id逗号分隔',
  `ns_vehicle_names`  varchar(100) NOT NULL COMMENT '车型名字多个名字逗号分隔',
  `begin_time` int(10) NOT NULL  COMMENT '开始时间',
  `end_time` int(10) NOT NULL  COMMENT '结束时间',
  `trigger_cfg` varchar(200)  NOT NULL  COMMENT '触发条件',
  `price_range` varchar(1000)  NOT NULL  COMMENT '价格范围',
  `op_name` varchar(50) NOT NULL DEFAULT "" COMMENT '操作人'  ,
  `op_uid` int(10)  NOT NULL DEFAULT 0  COMMENT '操作人uid',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `ix_begin_time_end_time_status`(`begin_time`,`end_time`,`status`),
  KEY `ix_updated_at`(updated_at),
  KEY `ix_created_at`(created_at)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='策略配置';

CREATE TABLE `strategy_city_vehicle_cfg` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '自增主键',
  `bussiness` tinyint(3) COMMENT '业务类型1 货运 2搬家',
  `status` tinyint(3) COMMENT '状态 0 未上线 1上线中 2下线',
  `strategy_id` int(10)  NOT NULL  COMMENT '策略id',
  `city_id`  int(10) NOT NULL COMMENT '城市id',
  `ns_vehicle_id` int(10) NOT NULL  COMMENT '车型id',
  `begin_time` int(10) NOT NULL  COMMENT '开始时间',
  `end_time` int(10) NOT NULL  COMMENT '结束时间',
  `op_name` varchar(50) NOT NULL DEFAULT "" COMMENT '操作人'  ,
  `op_uid` int(10)  NOT NULL DEFAULT 0 COMMENT '操作人uid',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
   KEY `ix_begin_time_end_time_status`(`begin_time`,`end_time`,`status`),
  KEY `ix_updated_at`(updated_at),
  KEY `ix_created_at`(created_at)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='城市+车型的策略配置';
```

1. 策略运营人员的变更记录表 

```SQL
CREATE TABLE `operate_log` (
  `id` bigint(10) NOT NULL AUTO_INCREMENT COMMENT '自增主键',
  `bussiness`int(10) COMMENT '业务类型',
  `operate_type` int(10) COMMENT '操作日志1新增2更新3删除',
  `item_count` int(10) COMMENT '操作条目数量',
  `op_name` varcahr(100) COMMENT '操作人'  ,
  `op_uid` int(10) COMMENT '操作人uid',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `b_e_t_idx`('begin_time','end_time','operate_type')
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='操作日志表';


CREATE TABLE `operate_log_value` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '自增主键',
  `operate_id`int(10) COMMENT '操作id',
  `item_id`int(10) COMMENT '业务id',
  `remark`int(10) COMMENT '业务备注',
  `old_value` text COMMENT '老数据',
  `new_value` text COMMENT '新数据',
  `op_name` varcahr(100) COMMENT '操作人'  ,
  `op_uid` int(10) COMMENT '操作人uid',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `o_b_e_idx`('operate_id','begin_time','end_time')
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='操作日志数据表';
```



1. 规则配置

算法每日生成一个配置表，其中里程段，时间段，响应率段都是设置死的，将每日的配置同步到redis中，在估价时根据固定死的段，找到对应的特征，根据特征+固定的时间段+固定的里程段，找到redis配置。

数据量级：每日156w左右，



优点：每日配置同步到redis中，提高查询效率。

​     缺点：

  \1. 可扩展性差，里程段和时间段和响应率段都是固定死的，需要扩展的话，肯定会存在一定的空窗期，无配置可用。

​                \2. 大车小车，搬家货运有自己不同的固定段，需要单独处理，无法通用。

​               \3. 特征的获取也得是有个固定的段，可扩展性差，只能算法自己去做特征的收集，大数据不好处理。



里程固定段如下：[0,5)[5,10)[10,15)[15,20)[20,25)[25,30)[30,35)[35,40)[40,45)[45,50)[50,100)[100,9999999)  

响应率[0,50)[50,80)[80,90)[90,95)[95,99.5)[99.5,100)。

无法复制加载中的内容

```SQL
CREATE TABLE `mileage_rule` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '自增主键',
  `bussiness` int(10) COMMENT '业务类型',
  `city_id`  int(10) NOT NULL DEFAULT '0' COMMENT '城市id',
  `ns_vehicle_id`  int(10) NOT NULL DEFAULT '0' COMMENT '车型名字多个名字逗号分隔',
  `begin_time` int(10) COMMENT '开始时间',
  `end_time` int(10) COMMENT '结束时间',
  `mileage`varchar(100) COMMENT '里程区间',
  `response_rate`varchar(100) COMMENT '响应率',
  `up_rate` int(10)  COMMENT '调价率',
  `up_price` int(10)  COMMENT '调价金额',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `e_b_t_idx`('end_time','begin_time')
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='规则';
```

1. OD规则

![img](https://huolala.feishu.cn/space/api/box/stream/download/asynccode/?code=NWMyYTBjMTc0ZDljNjYwNmI4NTg4ZDYyODI4MWE1YmNfand6alI2eUNMSmZycjBMeGNVTlJScmk1clNsWEtab1VfVG9rZW46Ym94Y25XUFZEMW5aVVBmZlVsaDNLc0tqV3FmXzE2Njk2MzkwNTg6MTY2OTY0MjY1OF9WNA)

- ### REDIS

| **用途**              | **类型** | **key**                            | 过期时间       | **字段结构**                                                 | 占用内存          | **描述**                                                     |
| --------------------- | -------- | ---------------------------------- | -------------- | ------------------------------------------------------------ | ----------------- | ------------------------------------------------------------ |
| 城市+车型是否命中策略 | HASH     | city:v:u:s:%d:%s:%ss:b%d:c:v:%d:%d | 策略的结束时间 | strategy_id                                                  |                   |                                                              |
| 策略缓存              | Hash     | stg:info:%d                        | 策略的结束时间 | {"strategy_id":1,"begin_tm":11,"end_time":111,"trigger_cfg":"触达条件","price_range":“价格区间”} |                   |                                                              |
| 规则配置              | HASH     | r:s:c%d:%d                         | 2天过期        | {"h3_level":1}                                               | <1M               |                                                              |
| 规则                  | HASH     | r:s:%s                             | 2天过期        | {"up_rate":10,"up_price":1}                                  | 100w*100=100M     | md5(city_id+ns_vehicle_id+hour+mileage+response_rate)之后，作为key的一部分。 |
| OD规则                | HASH     | r:od:s:%d:%d                       | 2天过期        | {"111213123123-12312312312":"{"up_rate":10,"up_price":1}"}   | 10w*132=15m       | 一个城市一个车型 作为key，field为所有的OD对。                |
| 下单次数              | string   |                                    | 40m            | 1                                                            | 100w*100=100M（） | 不同的自场景下每10分钟一个下单次数的string                   |
| 接单次数              | string   |                                    | 40m            | {1,2,3,4,5}                                                  |                   | 不同的自场景下每10分钟一个用户集合                           |
| 用户估价缓存          | hash     | user:c:s:%d:%d                     | 3min           |                                                              |                   |                                                              |
| 用户有估价id的缓存    | hash     | user:cid:s:c:s:%s                  | 3min           |                                                              |                   |                                                              |

- ## 性能评估

  - ### 性能分析

估价qps=250

- ### 监控&限流、熔断

redis<10G

Mysql 算法规则每日70-100w，年2亿数据，做分库分表

> 输入 @资源消耗评估，如需要部署节点数、redis存储、mysql存储空间消耗。

- ## 容灾分析

  - ### 安全架构

> 策略的名字需要展示到前端，是否需要接敏感词？

- ### 兼容与部署要求

> 3台api接口，两台admin服务

- ### 数据迁移方案

> 不涉及



📎 附件

1. [实时补贴详细设计](https://huolala.feishu.cn/wiki/wikcn8nY1Q8O3I1eLzVokgmt1sh) 